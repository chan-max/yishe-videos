name: Build and Push Docker Image

# è¯´æ˜Žï¼š
# 1. éœ€è¦åœ¨ GitHub Repository Settings -> Secrets and variables -> Actions ä¸­é…ç½®ä»¥ä¸‹ secrets:
#    - DOCKER_USERNAME: Docker Hub ç”¨æˆ·åï¼ˆä¾‹å¦‚ï¼š1sdesignï¼‰
#    - DOCKER_PASSWORD: Docker Hub å¯†ç æˆ–è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰
#    æŽ¨èä½¿ç”¨è®¿é—®ä»¤ç‰Œï¼šhttps://hub.docker.com/settings/security -> New Access Token
# 2. å·¥ä½œæµç¨‹ï¼š
#    - å½“ä»£ç æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
#    - ä»Ž package.json è¯»å–ç‰ˆæœ¬å·
#    - æž„å»º Docker é•œåƒï¼Œæ ‡ç­¾ä¸ºç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0.0ï¼‰å’Œ latest
#    - æŽ¨é€åˆ° Docker Hub
# 3. ä½¿ç”¨æ–¹æ³•ï¼š
#    - ä¿®æ”¹ package.json ä¸­çš„ version å­—æ®µï¼ˆå¦‚ï¼š1.0.0 -> 1.0.1ï¼‰
#    - æäº¤ä»£ç å¹¶æŽ¨é€åˆ° main åˆ†æ”¯
#    - GitHub Actions ä¼šè‡ªåŠ¨æž„å»ºå¹¶æŽ¨é€é•œåƒ

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æŽ¨é€
    # paths è¿‡æ»¤å™¨æ˜¯å¯é€‰çš„ï¼Œå¦‚æžœéœ€è¦ä»»ä½•æ–‡ä»¶å˜åŒ–éƒ½è§¦å‘ï¼Œå¯ä»¥åˆ é™¤ paths éƒ¨åˆ†
    # paths:
    #   - 'package.json'
    #   - 'Dockerfile'
    #   - 'server.js'
    #   - 'lib/**'
    #   - 'public/**'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å½“å‰ç‰ˆæœ¬: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/yishe-videos
          tags: |
            type=raw,value=${{ steps.package-version.outputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/yishe-videos:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/yishe-videos:buildcache,mode=max

      - name: Summary
        run: |
          echo "## ðŸ³ Docker é•œåƒæž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒåç§°**: \`${{ secrets.DOCKER_USERNAME }}/yishe-videos\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬æ ‡ç­¾**: \`${{ steps.package-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ ‡ç­¾**: \`latest\`, \`${{ steps.package-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä½¿ç”¨æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKER_USERNAME }}/yishe-videos:${{ steps.package-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æˆ–æ‹‰å– latest æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKER_USERNAME }}/yishe-videos:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d -p 1571:1571 ${{ secrets.DOCKER_USERNAME }}/yishe-videos:${{ steps.package-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

