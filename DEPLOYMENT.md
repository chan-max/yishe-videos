# yishe-videos è‡ªåŠ¨åŒ–éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ GitHub Actions + Docker + Docker Compose å®ç°è‡ªåŠ¨åŒ–æ„å»ºå’Œéƒ¨ç½²ã€‚

**å·¥ä½œæµç¨‹ï¼š**
1. ä¿®æ”¹ `package.json` ä¸­çš„ç‰ˆæœ¬å·
2. æ¨é€åˆ° GitHub `main` åˆ†æ”¯
3. GitHub Actions è‡ªåŠ¨æ„å»º Docker é•œåƒ
4. æ¨é€åˆ° Docker Hub
5. è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœé…ç½®äº†æœåŠ¡å™¨ä¿¡æ¯ï¼‰

---

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. GitHub Secrets é…ç½®

åœ¨ GitHub ä»“åº“ä¸­è¿›å…¥ï¼š`Settings` â†’ `Secrets and variables` â†’ `Actions` â†’ `New repository secret`

#### å¿…éœ€é…ç½®ï¼ˆæ„å»ºå’Œæ¨é€é•œåƒï¼‰

| Secret åç§° | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| `DOCKER_USERNAME` | Docker Hub ç”¨æˆ·å | `1sdesign` |
| `DOCKER_PASSWORD` | Docker Hub å¯†ç æˆ–è®¿é—®ä»¤ç‰Œ | `dckr_pat_xxxxx` |

> ğŸ’¡ **æ¨èä½¿ç”¨è®¿é—®ä»¤ç‰Œ**ï¼šhttps://hub.docker.com/settings/security â†’ New Access Token

#### å¯é€‰é…ç½®ï¼ˆè‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼‰

å¦‚æœä¸éœ€è¦è‡ªåŠ¨éƒ¨ç½²ï¼Œå¯ä»¥è·³è¿‡ä»¥ä¸‹é…ç½®ã€‚

| Secret åç§° | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------------|------|--------|------|
| `SERVER_HOST` | æœåŠ¡å™¨åœ°å€ | - | `192.168.1.100` æˆ– `example.com` |
| `SERVER_USERNAME` | SSH ç”¨æˆ·å | - | `root` |
| `SERVER_PASSWORD` | SSH å¯†ç  | - | `your_password` |
| `SERVER_SSH_KEY` | SSH ç§é’¥ï¼ˆæ¨èï¼‰ | - | `-----BEGIN OPENSSH PRIVATE KEY-----...` |
| `SERVER_PORT` | SSH ç«¯å£ | `22` | `22` |
| `SERVER_DEPLOY_PATH` | éƒ¨ç½²è·¯å¾„ | `/workspace/yishe-videos` | `/workspace/yishe-videos` |

> âš ï¸ **æ³¨æ„**ï¼š
> - å¦‚æœä¸è®¾ç½® `SERVER_HOST`ï¼Œå°†è·³è¿‡è‡ªåŠ¨éƒ¨ç½²æ­¥éª¤
> - `SERVER_PASSWORD` å’Œ `SERVER_SSH_KEY` äºŒé€‰ä¸€ï¼Œæ¨èä½¿ç”¨ SSH å¯†é’¥ï¼ˆæ›´å®‰å…¨ï¼‰

---

### 2. æœåŠ¡å™¨å‡†å¤‡å·¥ä½œ

#### 2.1 å®‰è£… Docker å’Œ Docker Compose

```bash
# å®‰è£… Dockerï¼ˆä»¥ Ubuntu ä¸ºä¾‹ï¼‰
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

#### 2.2 é…ç½® SSH å¯†é’¥ï¼ˆæ¨èï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨ SSH å¯†é’¥è¿æ¥æœåŠ¡å™¨ï¼š

```bash
# åœ¨æœ¬åœ°ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# å°†å…¬é’¥å¤åˆ¶åˆ°æœåŠ¡å™¨
ssh-copy-id username@server_host

# æµ‹è¯• SSH è¿æ¥
ssh username@server_host

# è·å–ç§é’¥å†…å®¹ï¼ˆç”¨äº GitHub Secretsï¼‰
cat ~/.ssh/id_rsa
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å‘å¸ƒæ–°ç‰ˆæœ¬

1. **ä¿®æ”¹ç‰ˆæœ¬å·**
   
   ç¼–è¾‘ `package.json`ï¼Œä¿®æ”¹ `version` å­—æ®µï¼š
   ```json
   {
     "version": "0.0.4"  // æ”¹ä¸ºæ–°ç‰ˆæœ¬ï¼Œå¦‚ 0.0.5
   }
   ```

2. **æäº¤å¹¶æ¨é€**
   ```bash
   git add package.json
   git commit -m "chore: bump version to 0.0.5"
   git push origin main
   ```

3. **è‡ªåŠ¨éƒ¨ç½²**
   - GitHub Actions ä¼šè‡ªåŠ¨è§¦å‘æ„å»º
   - æ„å»ºæˆåŠŸåæ¨é€åˆ° Docker Hub
   - å¦‚æœé…ç½®äº†æœåŠ¡å™¨ä¿¡æ¯ï¼Œä¼šè‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

> âš ï¸ **é‡è¦**ï¼šåªæœ‰ `package.json` æ–‡ä»¶å˜åŒ–æ—¶æ‰ä¼šè§¦å‘æ„å»ºå’Œéƒ¨ç½²ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦çš„æ„å»ºã€‚

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

### docker-compose.ymlï¼ˆæœ¬åœ°å¼€å‘ï¼‰

- **ç”¨é€”**ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒ
- **ç‰¹ç‚¹**ï¼šä½¿ç”¨ `build` ä» Dockerfile æ„å»ºé•œåƒ
- **ä½¿ç”¨åœºæ™¯**ï¼šå¼€å‘ã€æµ‹è¯•
- **å¯åŠ¨æ–¹å¼**ï¼š
  ```bash
  docker-compose up -d
  # æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
  ./docker-start.sh
  ```

### docker-compose.hub.ymlï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

- **ç”¨é€”**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- **ç‰¹ç‚¹**ï¼šä½¿ç”¨ Docker Hub ä¸Šçš„é•œåƒï¼ˆ`image: 1sdesign/yishe-videos:latest`ï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šç”Ÿäº§æœåŠ¡å™¨ã€CI/CD è‡ªåŠ¨éƒ¨ç½²
- **å¯åŠ¨æ–¹å¼**ï¼š
  ```bash
  docker-compose -f docker-compose.hub.yml up -d
  ```

> ğŸ’¡ **è¯´æ˜**ï¼šéƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»º `docker-compose.hub.yml` æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨ä¸Šä¼ ã€‚

---

## ğŸ” éƒ¨ç½²åæ“ä½œ

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
# è¿›å…¥éƒ¨ç½²ç›®å½•
cd /workspace/yishe-videos

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.hub.yml ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.hub.yml logs

# å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆæ¨èï¼‰
docker-compose -f docker-compose.hub.yml logs -f

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose -f docker-compose.hub.yml logs --tail=100
```

### é‡å¯æœåŠ¡

```bash
cd /workspace/yishe-videos

# é‡å¯å®¹å™¨
docker-compose -f docker-compose.hub.yml restart

# æ‹‰å–æœ€æ–°é•œåƒå¹¶é‡å¯
docker-compose -f docker-compose.hub.yml pull
docker-compose -f docker-compose.hub.yml up -d --force-recreate
```

### åœæ­¢æœåŠ¡

```bash
cd /workspace/yishe-videos

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.hub.yml down

# åœæ­¢ä½†ä¸åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.hub.yml stop
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose -f docker-compose.hub.yml logs --tail=100

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect yishe-videos

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 1571
# æˆ–
lsof -i :1571
```

### 2. é•œåƒæ‹‰å–å¤±è´¥

```bash
# æ£€æŸ¥ Docker Hub è¿æ¥
docker pull 1sdesign/yishe-videos:latest

# å¦‚æœä½¿ç”¨ç§æœ‰ä»“åº“ï¼Œéœ€è¦å…ˆç™»å½•
docker login
```

### 3. å¥åº·æ£€æŸ¥å¤±è´¥

```bash
# è¿›å…¥å®¹å™¨æ£€æŸ¥
docker exec -it yishe-videos /bin/bash

# æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£
curl http://localhost:1571/api/health

# æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨ç›‘å¬ç«¯å£
netstat -tlnp | grep 1571
```

### 4. ç›®å½•æƒé™é—®é¢˜

```bash
# æ£€æŸ¥ç›®å½•æƒé™
ls -la /workspace/yishe-videos

# ç¡®ä¿ç›®å½•æœ‰å†™æƒé™
chmod -R 755 /workspace/yishe-videos/uploads
chmod -R 755 /workspace/yishe-videos/output
chmod -R 755 /workspace/yishe-videos/template
```

---

## ğŸ“Š å·¥ä½œæµç¨‹è¯¦è§£

### è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿®æ”¹ package.jsonâ”‚
â”‚  ä¸­çš„ version    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨é€åˆ° GitHub   â”‚
â”‚   main åˆ†æ”¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub Actions  â”‚
â”‚   è‡ªåŠ¨è§¦å‘      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ„å»º Docker  â”‚  â”‚ è¯»å–ç‰ˆæœ¬å·      â”‚
â”‚   é•œåƒ       â”‚  â”‚ package.json    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨é€åˆ° Docker   â”‚
â”‚      Hub        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSH è¿æ¥æœåŠ¡å™¨ â”‚
â”‚  (å¦‚æœå·²é…ç½®)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‹‰å–æœ€æ–°é•œåƒ  â”‚  â”‚ åˆ›å»ºå¿…è¦ç›®å½•    â”‚
â”‚              â”‚  â”‚ (ä» volumes)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ é‡å¯ Docker     â”‚
        â”‚  å®¹å™¨æœåŠ¡       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ é«˜çº§é…ç½®

### è‡ªå®šä¹‰éƒ¨ç½²è·¯å¾„

å¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤è·¯å¾„ `/workspace/yishe-videos`ï¼Œå¯ä»¥åœ¨ GitHub Secrets ä¸­é…ç½® `SERVER_DEPLOY_PATH`ï¼š

- Secret åç§°ï¼š`SERVER_DEPLOY_PATH`
- å€¼ï¼š`/your/custom/path`

### ä½¿ç”¨ SSH å¯†é’¥ï¼ˆæ¨èï¼‰

1. åœ¨æœ¬åœ°ç”Ÿæˆ SSH å¯†é’¥å¯¹
2. å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨çš„ `~/.ssh/authorized_keys`
3. å°†ç§é’¥å†…å®¹å¤åˆ¶åˆ° GitHub Secrets çš„ `SERVER_SSH_KEY`

è¿™æ ·å¯ä»¥é¿å…åœ¨ GitHub ä¸­å­˜å‚¨å¯†ç ï¼Œæ›´åŠ å®‰å…¨ã€‚

### ç¦ç”¨è‡ªåŠ¨éƒ¨ç½²

å¦‚æœä¸å¸Œæœ›è‡ªåŠ¨éƒ¨ç½²ï¼Œåªéœ€ä¸é…ç½® `SERVER_HOST` secret å³å¯ã€‚GitHub Actions ä»ç„¶ä¼šæ„å»ºå’Œæ¨é€é•œåƒï¼Œä½†ä¸ä¼šæ‰§è¡Œéƒ¨ç½²æ­¥éª¤ã€‚

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç‰ˆæœ¬å·ç®¡ç†**ï¼šåªæœ‰ä¿®æ”¹ `package.json` ä¸­çš„ `version` å­—æ®µæ‰ä¼šè§¦å‘æ„å»ºï¼Œé¿å…ä¸å¿…è¦çš„æ„å»ºã€‚

2. **æ•°æ®æŒä¹…åŒ–**ï¼švolumes é…ç½®åœ¨ `docker-compose.hub.yml` ä¸­ï¼Œæ•°æ®ä¼šä¿å­˜åœ¨å®¿ä¸»æœºä¸Šï¼Œå³ä½¿å®¹å™¨åˆ é™¤ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

3. **ç«¯å£æ˜ å°„**ï¼šé»˜è®¤ç«¯å£æ˜¯ `1571`ï¼Œå¦‚éœ€ä¿®æ”¹ï¼Œéœ€è¦åŒæ—¶æ›´æ–°ï¼š
   - `docker-compose.hub.yml` ä¸­çš„ç«¯å£é…ç½®
   - `server.js` ä¸­çš„ PORT ç¯å¢ƒå˜é‡

4. **èµ„æºé™åˆ¶**ï¼šé»˜è®¤é™åˆ¶ CPU 2æ ¸ï¼Œå†…å­˜ 2Gï¼Œå¯æ ¹æ®æœåŠ¡å™¨å®é™…æƒ…å†µè°ƒæ•´ã€‚

5. **ç›¸å¯¹è·¯å¾„**ï¼šå‰ç«¯ä»£ç å·²ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œä¼šè‡ªåŠ¨é€‚é…å½“å‰è®¿é—®åœ°å€ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹æ£€æŸ¥æ¸…å•

- [ ] GitHub Secrets å·²é…ç½®ï¼ˆè‡³å°‘ `DOCKER_USERNAME` å’Œ `DOCKER_PASSWORD`ï¼‰
- [ ] æœåŠ¡å™¨å·²å®‰è£… Docker å’Œ Docker Compose
- [ ] å¦‚éœ€è‡ªåŠ¨éƒ¨ç½²ï¼Œå·²é…ç½®æœåŠ¡å™¨ç›¸å…³çš„ Secrets
- [ ] å·²æµ‹è¯• SSH è¿æ¥åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼‰
- [ ] äº†è§£ç‰ˆæœ¬å‘å¸ƒæµç¨‹ï¼ˆä¿®æ”¹ package.json ä¸­çš„ versionï¼‰

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. GitHub Actions æ—¥å¿—ï¼š`Actions` â†’ é€‰æ‹©æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ
2. æœåŠ¡å™¨æ—¥å¿—ï¼š`docker-compose -f docker-compose.hub.yml logs -f`
3. å®¹å™¨çŠ¶æ€ï¼š`docker-compose -f docker-compose.hub.yml ps`

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€

